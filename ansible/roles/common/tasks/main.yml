---

  - name: Build hosts file with pub. access hosts
    lineinfile:
      dest: /etc/hosts
      regexp: '.*{{ item }}$'
      line: "{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}"
      state: present
    when: hostvars[item].ansible_default_ipv4.address is defined
    with_items:
      - "{{ groups['nodes_pub_access_eth'] }}"
      - "{{ groups['master'] }}"

  - name: Build hosts file with nat hosts
    lineinfile:
      dest: /etc/hosts
      regexp: '.*{{ item }}$'
      line: "{{ hostvars[item].ansible_host }} {{ item }}"
      state: present
    with_items: groups.scaleway_nodes

  - name: Add Epel Repo
    yum:
      name: epel-release
      state: latest

  - name: Install utils and stuff
    yum:
      name: "{{ item }}"
      state: latest
    with_items:
      - "{{ utils_rpm }}"

  - include: fail2ban.yml
  - include: firewall.yml
